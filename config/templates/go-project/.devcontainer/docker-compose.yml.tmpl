services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      proxy:
        condition: service_healthy
    networks:
      - isolated
    environment:
      - http_proxy=http://proxy:{{.ProxyPort}}
      - https_proxy=http://proxy:{{.ProxyPort}}
      - HTTP_PROXY=http://proxy:{{.ProxyPort}}
      - HTTPS_PROXY=http://proxy:{{.ProxyPort}}
      - no_proxy=localhost,127.0.0.1
      - NO_PROXY=localhost,127.0.0.1
      - SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
      - REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
      - IS_DEMO=1
    volumes:
      - {{.ProjectPath}}:{{.WorkspaceFolder}}:cached
      - proxy-certs:/tmp/mitmproxy-certs:ro
      # Persistent dotfiles (from template seed files)
      - {{.ProjectPath}}/.devcontainer/containers/app/home/vscode/.bashrc:/home/vscode/.bashrc:cached
      - {{.ProjectPath}}/.devcontainer/containers/app/home/vscode/.zshrc:/home/vscode/.zshrc:cached
      - {{.ProjectPath}}/.devcontainer/containers/app/home/vscode/.tmux.conf:/home/vscode/.tmux.conf:cached
      - {{.ProjectPath}}/.devcontainer/containers/app/home/vscode/.claude:/home/vscode/.claude:cached
      - {{.ClaudeTokenPath}}:/run/secrets/claude-token:ro
      - {{.GitHubTokenPath}}:/run/secrets/github-token:ro
    cap_drop:
      - NET_RAW
      - SYS_ADMIN
      - SYS_PTRACE
      - MKNOD
      - NET_ADMIN
      - SYS_MODULE
      - SYS_RAWIO
      - SYS_BOOT
      - SYS_NICE
      - SYS_RESOURCE
    mem_limit: 4g
    cpus: "2"
    pids_limit: 512
    labels:
      devagent.managed: "true"
      devagent.project_path: "{{.ProjectPath}}"
      devagent.template: "{{.TemplateName}}"
    entrypoint: ["sh", "{{.WorkspaceFolder}}/.devcontainer/entrypoint.sh"]
    command: ["sleep", "infinity"]

  proxy:
    image: mitmproxy/mitmproxy:latest
    networks:
      - isolated
    volumes:
      - proxy-certs:/home/mitmproxy/.mitmproxy
      - {{.ProjectPath}}/.devcontainer/containers/proxy/opt/devagent-proxy:/opt/devagent-proxy
    command: ["mitmdump", "--listen-host", "0.0.0.0", "--listen-port", "{{.ProxyPort}}", "-s", "/opt/devagent-proxy/filter.py"]
    healthcheck:
      test: ["CMD", "test", "-f", "/home/mitmproxy/.mitmproxy/mitmproxy-ca-cert.pem"]
      interval: 2s
      timeout: 1s
      retries: 15
      start_period: 5s
    labels:
      devagent.managed: "true"
      devagent.sidecar_type: "proxy"

networks:
  isolated:

volumes:
  proxy-certs:
