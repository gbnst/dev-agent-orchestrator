from mitmproxy import ctx, http
import re

# Allowlist of permitted domains
# Wildcards are supported: "*.github.com" matches "api.github.com"
ALLOWED_DOMAINS = [
    "api.anthropic.com",
    "claude.ai",
    "*.claude.ai",
    "platform.claude.com",
    "sentry.io",
    "*.sentry.io",
    "statsigapi.net",
    "github.com",
    "*.github.com",
    "api.github.com",
    "raw.githubusercontent.com",
    "objects.githubusercontent.com",
    "registry.npmjs.org",
    "pypi.org",
    "files.pythonhosted.org",
    "proxy.golang.org",
    "sum.golang.org",
    "storage.googleapis.com",
    "pkg.go.dev",
]

# Passthrough domains bypass TLS interception entirely (for certificate pinning).
# These are set via mitmproxy's ignore_hosts option in the load() hook below,
# replacing the previous --ignore-hosts CLI flag generated by Go code.
PASSTHROUGH_DOMAINS = []

# Block GitHub PR merge API calls.
# The @blockGitHubPRMerge flag from the old allowlist.txt format becomes this
# Python boolean. True = block merge API calls, False = allow them.
BLOCK_GITHUB_PR_MERGE = True


def load(loader):
    """Configure mitmproxy options at addon load time."""
    if PASSTHROUGH_DOMAINS:
        # Convert domain patterns to mitmproxy ignore_hosts regex format.
        # Each domain becomes a regex: "example.com" -> "^example\\.com$"
        # Wildcards: "*.example.com" -> "^.*\\.example\\.com$"
        patterns = []
        for domain in PASSTHROUGH_DOMAINS:
            if domain.startswith("*."):
                pattern = r"^.*\." + re.escape(domain[2:]) + "$"
            else:
                pattern = "^" + re.escape(domain) + "$"
            patterns.append(pattern)
        ctx.options.ignore_hosts = patterns


class AllowlistFilter:
    """Blocks requests to domains not in the allowlist and optionally blocks PR merges."""

    def _is_allowed(self, host: str) -> bool:
        """Check if host matches any allowed domain pattern."""
        for pattern in ALLOWED_DOMAINS:
            if pattern.startswith("*."):
                # Wildcard pattern: matches exact or any subdomain
                base = pattern[2:]  # Remove "*."
                if host == base or host.endswith("." + base):
                    return True
            elif host == pattern:
                return True
        return False

    def _is_github_pr_merge(self, flow: http.HTTPFlow) -> bool:
        """Check if request is a GitHub PR merge attempt."""
        if not BLOCK_GITHUB_PR_MERGE:
            return False

        host = flow.request.pretty_host
        if host not in ("api.github.com", "github.com") and not host.endswith(".github.com"):
            return False

        # REST API: PUT /repos/{owner}/{repo}/pulls/{number}/merge
        if flow.request.method == "PUT":
            if re.match(r"^/repos/[^/]+/[^/]+/pulls/\d+/merge$", flow.request.path):
                return True

        # GraphQL API: POST /graphql with mergePullRequest mutation
        if flow.request.method == "POST" and flow.request.path == "/graphql":
            content = flow.request.get_text()
            if content and "mergePullRequest" in content:
                return True

        return False

    def request(self, flow: http.HTTPFlow) -> None:
        # Check PR merge block first
        if self._is_github_pr_merge(flow):
            flow.response = http.Response.make(
                403,
                b"Merging pull requests is not allowed in this environment. Do not retry.\n",
                {"Content-Type": "text/plain"}
            )
            return

        host = flow.request.pretty_host
        if not self._is_allowed(host):
            flow.response = http.Response.make(
                403,
                f"Domain '{host}' is not in the allowlist\n".encode(),
                {"Content-Type": "text/plain"}
            )

addons = [AllowlistFilter()]
